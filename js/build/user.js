/*! wozhongla 2015-01-23 */
define("wzlh5/1.0.0/user",["jquery/2.1.1/jquery","wzlh5/1.0.0/ac","handlebars/1.3.0/dist/cjs/handlebars","wzlh5/1.0.0/until","wzlh5/1.0.0/cp","wzlh5/1.0.0/ui"],function(require){function register(ac){function register(type){$("#reg").unbind("click"),$("#reg").on("click",function(){var $uname=$('input[name="username"]').val(),$upwd=$('input[name="password"]').val(),$code=$("#code").val(),re=/^\w+$/,re2=/^[\w+]{5,15}/;if(!re.test($uname))return dialog("tips","用户名，请重新输入"),!1;if(!re2.test($upwd))return dialog("tips","密码有误，请重新输入"),!1;if(!$("#reg-check").prop("checked"))return dialog("tips","请您先同意用户协议和法律声明后再试！"),!1;if(!$uname)return dialog("tips","账号错误，请正确填写"),!1;if(!$upwd)return dialog("tips","密码错误，请正确填写"),!1;if(!$code)return dialog("tips","验证码不能为空"),!1;var data;data="usermobile"==type?{usermobile:$uname,password:$upwd,code:$code}:{username:$uname,password:$upwd,code:$code},actions.register(data,function(re){"200"==re.resultCode?(Ls.clear(),Ls.set("balance",0),Ls.set("username",re.data.userName),window.location.href="registerok.html?userName="+re.data.userName+"&userMobile="+re.data.userMobile||""):setTimeout(function(){dialog("tips",re.data)},2e3)})})}function registerok(){$("#username").text(decodeURIComponent(untils.getRequestParameter("userName"))),"null"!=untils.getRequestParameter("userMobile")?($("#isPhone").removeClass("wzl-text-warning").text(untils.getRequestParameter("userMobile")),$("#verify-btn").remove()):$("#changeuser").remove(),$("#registerok").on("click",function(){location.href="ucenter.html"})}var actions=action,untils=until,rules=untils.RULES,verifyCode=verify();switch(ac){case"registerok":registerok()}$('input[name="username"]').focus(),$("#glyphicon-wzl-eye").on("click",function(){"text"==$("#password").attr("type")?$("#password").attr("type","password"):$("#password").attr("type","text")}),$("form").submit(function(){return!1}),$(document).keydown(function(e){var $val=$(this).val().trim();"13"==e.keyCode&&(rules.MOBILE.test($val)?(verifyCode.toSwitch("phone"),register("usermobile")):rules.EMAIL.test($val)?(verifyCode.toSwitch("img"),register("useremail")):(verifyCode.toSwitch("img"),register("username")))}),$('input[name="username"]').on("blur",function(){var $val=$(this).val().trim();verifyCode.show(),$(".register-tips").hide(),rules.MOBILE.test($val)?(verifyCode.toSwitch("phone"),register("usermobile")):rules.EMAIL.test($val)?(verifyCode.toSwitch("img"),register("useremail")):(verifyCode.toSwitch("img"),register("username"))}),verifyCode.action(function(refresh,phoneCode){refresh.on("click",function(){verifyCode.refreshImg("phone"),$("#code").val("")}),phoneCode.on("click",function(){$("#code").val("");var $uphone=$('input[name="username"]').val().trim(),i=60,timer=null;return rules.MOBILE.test($uphone)&&(timer=setInterval(function(){i--,phoneCode.addClass("disabled"),phoneCode.html("再次获取("+i+")秒"),0==i&&(clearInterval(timer),phoneCode.removeClass("disabled"),phoneCode.html("再次获取"))},1e3)),actions.getCode({userMobile:$uphone,mess:"userRegister"},function(re){"200"==re.resultCode?dialog("发送验证码成功"):dialog("tips","抱歉,验证码发送失败...")}),!1})});var serverPop=iscrollPop({title:"用户协议 和 法律声明",content:$(".yhxy").html(),onclose:function(){}});$(".wzl-server-a").click(function(){serverPop.show()})}function login(){var actions=action,untils=until,rules=untils.RULES,verifyCode=verify(),ref=untils.getRequestParameter("ref");verifyCode.show(),verifyCode.toSwitch("img"),verifyCode.action(function(refresh,phoneCode){refresh.on("click",function(){verifyCode.refreshImg(),$('input[name="vercode"]').val("")}),phoneCode.on("click",function(){var $uphone=$('input[name="username"]').val().trim(),i=60,timer=null;return rules.MOBILE.test($uphone)&&(timer=setInterval(function(){i--,phoneCode.addClass("disabled"),phoneCode.html("再次获取("+i+")秒"),0==i&&(clearInterval(timer),phoneCode.removeClass("disabled"),phoneCode.html("再次获取"),i=60)},1e3)),!1})}),$("#login").on("click",function(){var $uname=$('input[name="username"]').val(),$upwd=$('input[name="password"]').val(),$vercode=$('input[name="vercode"]').val();return $uname?$upwd?$vercode?void actions.login({userName:$uname,passWord:$upwd,code:$vercode},function(re){if("200"==re.resultCode){var h=untils.shref[ref];untils.ref(h||"ucenter.html")}else"405"==re.resultCode?setTimeout(function(){dialog("tips",re.data)},1e3):setTimeout(function(){dialog("tips","账号或密码错误，请重试。")},1e3)}):(dialog("tips","验证码不能为空"),!1):(dialog("tips","密码不能为空"),!1):(dialog("tips","用户名不能为空"),!1)}),$(".Oauth_login a").on("click",function(){dialog("tips","暂未开通联合登录，敬请期待")})}function userA(ac){function loginJudge(){action.queryUserInfo({},function(re){return"200"==re.resultCode&&"用户没有登录"==re.data.message?void untils.ref("login",location.search):void 0})}function verifyPhone(){loginJudge("ucenter"),$('input[name="phone"]').on("focusout",function(){var $val=$(this).val().trim();rules.MOBILE.test($val)&&verifyCode.toSwitch("phone")});var $phoneCode=$(".wzl-getverify-phone"),timei=($('input[name="phone"]').val(),60),timer=null;$phoneCode.on("click",function(){var $vercode=$("#phone").val().trim();timer=setInterval(function(){timei--,$phoneCode.addClass("disabled"),$phoneCode.html("再次获取("+timei+")秒"),0>=timei&&(clearInterval(timer),timei=60,$phoneCode.removeClass("disabled"),$phoneCode.html("再次获取"))},1e3),actions.getCode({userMobile:$vercode,mess:"bindMobile"},function(re){"200"==re.resultCode?dialog("发送验证码成功"):dialog("tips","抱歉,验证手机失败...")})}),$("#verifyPhone").click(function(){var $up=$("#phone").val().trim(),$code=$("#vercode").val().trim();return $up&&rules.MOBILE.test($up)?$code?void(rules.MOBILE.test($up)&&$code&&actions.verifyMobile({userMobile:$up,code:$code},function(re){"200"==re.resultCode?(dialog("恭喜您绑定手机成功"),setTimeout(function(){location.href="ucenter.html"},3e3)):dialog("tips",re.data)})):void dialog("tips","请输入正确验证码"):void dialog("tips","请输入正确的手机号")})}function completeInfo(){function userComplete(){var r=Math.random()>.5;r?step2():step3()}function step2(){$("#complete-info-step1").animate({opacity:"0",height:"0"},500,function(){$("#complete-info-step1").hide()}),$("#complete-info-step2").animate(600).show();var $phoneCode=$(".wzl-getverify-phone"),timei=60,timer=null;$phoneCode.on("click",function(){timer=setInterval(function(){timei--,$phoneCode.addClass("disabled"),$phoneCode.html("再次获取("+timei+")秒"),0==timei&&(clearInterval(timer),$phoneCode.removeClass("disabled"),$phoneCode.html("再次获取"))},1e3)}),$("#bind1").on("click",function(){var $code=$(".wzl-verify-input").val().trim(),$pwd=$("#password1").val().trim();$code?!$pwd||$pwd.length<6?dialog("密码格式有误"):(dialog("loading","完善信息中..."),setTimeout(function(){dialog("完善成功！")},4e3)):dialog("请输入验证码")})}function step3(){$("#complete-info-step1").animate({opacity:"0",height:"0"},500,function(){$("#complete-info-step1").hide()}),$("#complete-info-step3").animate(600).show(),$("#bind2").on("click",function(){var $up2=$("#phone1").val().trim();rules.MOBILE.test($up2)?(dialog("loading","正在绑定"),setTimeout(function(){dialog({type:"tips",message:"绑定失败，请重试"})},2e3)):dialog("手机号码有误")})}{var $phone=$("#phone"),$checkbtn=$("#checkphone");$("#bind1"),$("#bind2")}$checkbtn.on("click",function(){var $up=$phone.val().trim();rules.MOBILE.test($up)?userComplete($up):dialog("手机号码有误！")})}function findpwd(){function setPwd(){$("#findstep1").animate({opacity:0,height:0},500,function(){$("#findstep1").hide()}),$("#findstep2").animate(600).show(),$("#checkok").click(function(){var $old=$("#oldpwd").val().trim(),$new=$("#newpwd").val().trim(),$uname=$("#uname").val().trim(),$verifycode=$("#verifycode").val().trim();$old&&$new?$old!==$new?dialog("tips","重复密码错误"):actions.backPwd({userMobile:$uname,nPass:$new,code:$verifycode},function(re){"200"==re.resultCode?(dialog("恭喜您修改成功.2秒后跳转登录页."),setTimeout(function(){location.href="login.html"},2e3)):dialog(re.data)}):dialog("tips","请填写完整！")})}$("#glyphicon-wzl-eye").on("click",function(){"text"==$("#oldpwd").attr("type")?$("#oldpwd,#newpwd").attr("type","password"):$("#oldpwd,#newpwd").attr("type","text")});var $phoneCode=$(".wzl-getverify-phone"),$uname=$("#uname"),$code=$("#verifycode"),timei=60,timer=null;$phoneCode.on("click",function(){timer=setInterval(function(){timei--,$phoneCode.addClass("disabled"),$phoneCode.html("再次获取("+timei+")秒"),0>=timei&&(clearInterval(timer),$phoneCode.removeClass("disabled"),$phoneCode.html("再次获取"),timei=60)},1e3),actions.backPwdCode({userMobile:$uname.val()},function(re){dialog("200"==re.resultCode?"验证成功":re.data)})}),$("#verifyphone").on("click",function(){var $un=$uname.val().trim(),$co=$code.val().trim();$un&&$co?actions.verifyCode({userMobile:$un,code:$co},function(re){"200"==re.resultCode?setPwd():dialog(re.data)}):dialog("tips","手机号或验证码不能为空...")})}function modifypwd(){loginJudge("ucenter"),$("#glyphicon-wzl-eye").on("click",function(){"password"==$("#newpwd").attr("type")?($("#newpwd").attr("type","text"),$("#repwd").attr("type","text")):($("#newpwd").attr("type","password"),$("#repwd").attr("type","password"))}),$("#newpwd,#oldpwd,#repwd").on("keyup focusout",function(){function checklen(v){return v.length>5}function checknew(newpwd,repwd){return checklen(newpwd)&&checklen(repwd)&&newpwd==repwd}var $val1=$("#oldpwd").val().trim(),$val2=$("#newpwd").val().trim(),$val=$("#repwd").val().trim();checklen($val)&&checklen($val1)&&checklen($val2)&&checknew($val2,$val)?$("#modifybtn").removeClass("disabled"):$("#modifybtn").addClass("disabled")}),$("#modifybtn").on("click",function(){var $old=$("#oldpwd").val().trim(),$new=$("#newpwd").val().trim(),$re=$("#repwd").val().trim();if($old==$new)return dialog("tips","新旧密码不能一致"),!1;if($old&&$new&&$re)if($new!==$re)dialog("tips","重复密码错误");else{var dia=dialog("loading","发送改密码请求");action.updatePwd({userMobile:Ls.get("username"),oPass:$old,nPass:$new},function(re){"200"==re.resultCode?(dia.hide(),setTimeout(function(){dialog("恭喜您修改密码成功！")},300),setTimeout(function(){location.href="ucenter.html"},3e3)):(dia.hide(),setTimeout(function(){dialog("tips",re.data)},2e3))})}else dialog("tips","请填写完整！")})}function ucenter(){setTimeout(function(){$(".container-mask").hide(),$(".container").removeClass("hidden")},500),action.queryUserAllInfo({},function(re){if("200"==re.resultCode&&"用户没有登录"!=re.data){$(".ubar").text("您好，"+re.data.userinfo.username),null==re.data.userinfo.mobile?($("#bondPhone").show(),$("#bondPhone").parent().attr("href","verifyphone.html")):$("#bondPhone").text("绑定号为 "+re.data.userinfo.mobile),null==re.data.userinfo.idcard?$("#bondIdcard").show():$("#bondIdcard").remove(),re.data.bindInfo.length?$("#bondBankcard").hide():$("#bondBankcard").show(),re.data.u_xj=re.data.accountInfo[0].balance,re.data.u_cj=parseInt(re.data.accountInfo[1].balance)+parseInt(re.data.accountInfo[2].balance)+"";var moneyTemplate=Handlebars.compile($("#money-template").html());$("#money_info_block").html(moneyTemplate({data:re.data})),$("#paycenter").on("click",function(){location.href="paycenter.html"}),$("#cashcenter").on("click",function(){location.href="cashcenter.html"})}else location.href="login.html"}),$("#logout").on("click",function(){dialog({type:"select",message:"您确认退出吗？",onConfirm:function(){action.logout({},function(re){"200"==re.resultCode&&(location.href="login.html")})},onCancel:function(){}})})}function udata(){action.queryUserInfo({},function(re){if("200"==re.resultCode&&"0"==re.data.statusCode){re.data.userinfo.realName&&Ls.set("realname",re.data.userinfo.realName),re.data.userinfo.idcard&&Ls.set("idcard",re.data.userinfo.idcard),re.data.userinfo.address&&Ls.set("address",re.data.userinfo.address);var reg=/wzl/;null!=re.data.userinfo.mobile&&reg.test(re.data.userinfo.username)?$("#motifyusername").removeClass("hidden"):$("#motifyusername").remove(),$(".udatam-uname").html(re.data.userinfo.username),null==re.data.userinfo.idcard?$("#motifyid").removeClass("hidden"):($("#motifyid").removeClass("hidden"),$(".udatam-uidname").html(re.data.userinfo.realName),$(".udatam-uid").html(re.data.userinfo.idcard),$(".udatam-address").html(re.data.userinfo.address))}else dialog("tips","暂无数据显示"),location.href("login.html")}),loginJudge("ucenter"),setTimeout(function(){$(".container-mask").hide(),$(".container").removeClass("hidden")},1e3)}function udataName(){loginJudge("ucenter");var $un=$('input[name="username"]');$("#udata-name").on("click",function(){var $unv=$un.val().trim();$unv?(dialog("保存信息中"),actions.uchangeName({username:encodeURIComponent($unv)},function(re){"200"==re.resultCode?(dialog("tips","恭喜您修改用户名成功"),setTimeout(function(){location.href="ucenter.html"},3e3)):dialog(re.data)})):dialog("请填写用户名")})}function udataId(){loginJudge("ucenter"),action.queryUserInfo({},function(re){if("200"==re.resultCode&&"0"==re.data.statusCode){var relname=re.data.userinfo.realName,idcard=re.data.userinfo.idcard,address=re.data.userinfo.address;null!=relname&&$("#realname").attr("disabled","disabled").val(relname),null!=idcard&&$("#idcard").attr("disabled","disabled").val(idcard),null!=address&&$("#address").val(address)}else dialog("tips","暂未查到您的身份信息，可能导致修改资料失败...")});var $un=$('input[name="username"]'),$ud=$('input[name="useraddress"]'),$uid=$('input[name="userid"]');$("#udata-id").on("click",function(){var reg=/(^\d{15}$)|(^\d{18}$)|(^\d{17}(\d|X|x)$)/,$unv=$un.val().trim(),$udv=$ud.val().trim(),$uidv=$uid.val().trim();return reg.test($uidv)?$unv&&$uidv?void actions.modifyId({realname:encodeURIComponent($unv),idcard:$uidv,address:encodeURIComponent($udv)},function(re){"200"==re.resultCode?(dialog("tips","恭喜您绑定资料成功"),setTimeout(function(){location.href="udatamanage.html"},2e3)):"400"==re.resultCode?dialog("tips",re.data):dialog("tips","绑定资料失败，请重试...")}):void dialog("请填写完整信息"):void dialog("请输入正确的身份证号!")})}var actions=action,untils=until,rules=untils.RULES,verifyCode=verify();switch(ac){case"verifyPhone":verifyPhone();break;case"completeInfo":completeInfo();break;case"findpwd":findpwd();break;case"modifypwd":modifypwd();break;case"udata":udata();break;case"udataname":udataName();break;case"udataid":udataId();break;default:ucenter()}}var $=require("jquery/2.1.1/jquery"),until=require("wzlh5/1.0.0/until"),action=require("wzlh5/1.0.0/ac"),wzlui=require("wzlh5/1.0.0/ui"),Handlebars=(require("wzlh5/1.0.0/cp"),require("handlebars/1.3.0/dist/cjs/handlebars").default),iscrollPop=(wzlui.containerMask,wzlui.iscrollPop),dialog=wzlui.dialog,Ls=(wzlui.containerMask,wzlui.dropdownMask,until.Y_Y,until.TZ_INFO,until.Ls);return verify=function(){function toSwitch(str){"phone"==str?$imgBlock.animate({right:"120"},300)&&$phoneBlock.animate({right:"0"},300):$phoneBlock.animate({right:"120"},300)&&$imgBlock.animate({right:"0"},300)}function show(){refreshImg(),$(".wzl-verifycode-block").show()}function refreshImg(){$(".wzl-verify-code").attr("src",action.INF_CONFIG+"wzlInterface/servicesAPI/mobile/getCode?"+Math.random())}function hide(){$(".wzl-verifycode-block").hide()}function result(){var $val=$(".wzl-verify-input").val().trim();return $val}function _action(fn){$refresh.on("click",function(){$imgCode.attr("src",action.INF_CONFIG+"wzlInterface/servicesAPI/mobile/getCode?"+Math.random())}),fn($refresh,$phoneCode,$imgCode,result)}var $phoneBlock=$(".wzl-verifyphone-block"),$imgBlock=$(".wzl-verifyimg-block"),$imgCode=$(".wzl-verify-code"),$refresh=$(".wzl-verify-refresh"),$phoneCode=$(".wzl-getverify-phone");return{toSwitch:toSwitch,show:show,hide:hide,result:result,action:_action,refreshImg:refreshImg}},{register:register,login:login,userA:userA}});